name: CI Pipeline

on: [push, pull_request]

jobs:
  test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.12'

      - name: Install Poetry
        run: curl -sSL https://install.python-poetry.org | python3 -

      - name: Add Poetry to PATH
        run: echo "${HOME}/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: poetry install

      - name: Run tests
        run: poetry run pytest

      - name: Run tests with coverage
        run: poetry run coverage run -m pytest

      - name: Generate coverage report
        run: poetry run coverage report

  black:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.12'

      - name: Install Poetry
        run: curl -sSL https://install.python-poetry.org | python3 -

      - name: Add Poetry to PATH
        run: echo "${HOME}/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: poetry install

      - name: Run Black
        run: poetry run black .

  python-ci:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.12'

      - name: Install Poetry
        run: curl -sSL https://install.python-poetry.org | python3 -

      - name: Add Poetry to PATH
        run: echo "${HOME}/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: poetry install

      - name: Set up pyenv
        run: |
          curl https://pyenv.run | bash
          echo 'export PYENV_ROOT="$HOME/.pyenv"' >> $HOME/.zshrc
          echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> $HOME/.zshrc
          echo 'eval "$(pyenv init --path)"' >> $HOME/.zshrc
          echo 'eval "$(pyenv virtualenv-init -)"' >> $HOME/.zshrc
        shell: zsh

      - name: Initialize pyenv
        run: |
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PATH"
          eval "$(pyenv init --path)"
          eval "$(pyenv virtualenv-init -)"
        shell: zsh

  qodana:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2

      - name: Run Qodana
        run: |
          docker run -it --rm \
          -v $(pwd):/data/project \
          jetbrains/qodana:latest
